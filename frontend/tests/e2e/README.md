# CloudTouch E2E Tests (Cypress)

End-to-End Tests für die CloudTouch Frontend User Journey.

## Setup

```bash
cd frontend
npm install
```

## Running Tests

### Interactive Mode (Development)
```bash
npm run test:e2e:open
```

### Headless Mode (CI)
```bash
# Default (Mock Mode)
npm run test:e2e

# Explicit Mock Mode
npm run test:e2e:mock

# Real Device Mode
npm run test:e2e:real
```

## Test Structure

```
tests/e2e/
├── fixtures/              # Test data (mock devices, IPs)
├── support/
│   ├── commands.js       # Custom Cypress commands
│   └── e2e.js           # Global setup/teardown
├── manual-ip-configuration.cy.js  # IP config tests
├── device-discovery.cy.js         # Discovery tests
└── README.md
```

## Test Coverage

### Manual IP Configuration (`manual-ip-configuration.cy.js`)
- ✅ EmptyState modal opening
- ✅ Single IP configuration (1 device)
- ✅ Multiple IPs (2, 3 devices)
- ✅ Edge case: Many IPs (10+)
- ✅ Edge case: Character limit validation
- ✅ Cancel action (no save)
- ✅ Pre-filled IPs (edit existing)
- ✅ Complete first-time user journey
- ✅ Returning user journey

### Device Discovery (`device-discovery.cy.js`)
- ✅ Mock mode discovery
- ✅ Device details display
- ✅ No devices found state
- ✅ Error handling

## Custom Commands

### API Commands
- `cy.setManualIPs(ips)` - Set manual IPs via API
- `cy.getManualIPs()` - Get manual IPs from API
- `cy.syncDevices()` - Trigger device sync
- `cy.getDevices()` - Get all devices from API
- `cy.clearManualIPs()` - Clear all manual IPs

### UI Commands
- `cy.openIPConfigModal()` - Open manual IP config modal
- `cy.closeModal()` - Close modal via cancel button
- `cy.saveIPsInModal(ips)` - Enter and save IPs
- `cy.waitForModalClose()` - Wait for modal auto-close
- `cy.triggerDiscovery()` - Click discovery button
- `cy.verifyDeviceCount(n)` - Verify N devices visible

## Mock vs Real Mode

### Mock Mode (Default)
- Uses mock devices generated by backend
- Fast, deterministic tests
- No real hardware required
- Database reset before each test

### Real Mode
- Connects to actual SoundTouch devices
- Requires devices on network
- Manual IP configuration necessary
- Tests against production behavior

## Environment Variables

```javascript
// cypress.config.js
env: {
  mode: 'mock',           // 'mock' or 'real'
  apiUrl: 'http://localhost:7777/api'
}
```

## CI/CD Integration

```yaml
# Example GitHub Actions workflow
- name: Run E2E Tests
  run: |
    npm run test:e2e:mock
```

## Debugging

### Screenshots
Failed tests automatically save screenshots to:
```
tests/e2e/screenshots/
```

### Videos
Test runs are recorded to:
```
tests/e2e/videos/
```

### Cypress UI
```bash
npm run test:e2e:open
```

## Best Practices

1. **Element Existence**: Always check element exists before interaction
2. **API Validation**: Verify DB state via API calls
3. **Isolation**: Each test starts with clean state (beforeEach)
4. **Custom Commands**: Reuse common actions via custom commands
5. **Fixtures**: Use fixtures for test data consistency

## Example Test

```javascript
it('should save 2 IPs and create 2 devices', () => {
  cy.fixture('mock-devices').then((data) => {
    const ips = data.two_ips

    // Open modal and configure
    cy.openIPConfigModal()
    cy.saveIPsInModal(ips)
    cy.waitForModalClose()

    // Verify API state
    cy.getManualIPs().should('deep.equal', ips)

    // Trigger discovery
    cy.triggerDiscovery()

    // Verify UI state
    cy.verifyDeviceCount(2)
    cy.get('.device-card').should('contain', ips[0])
  })
})
```

## Troubleshooting

### Test Hangs
- Check if backend is running (`http://localhost:7777/health`)
- Verify mock mode is enabled in backend (`CT_MOCK_MODE=true`)
- Check browser console for errors (Cypress UI)

### Modal Not Found
- Ensure EmptyState is rendered (no existing devices in DB)
- Check button selector matches actual text

### Device Count Mismatch
- Verify manual IPs were saved (`cy.getManualIPs()`)
- Check sync response (`cy.syncDevices()`)
- Inspect browser DevTools Network tab

## Future Enhancements

- [ ] Device interaction tests (play, pause, volume)
- [ ] Radio station tests
- [ ] Settings page tests
- [ ] Multi-device control tests
- [ ] Network error scenarios
- [ ] Browser compatibility matrix (Chrome, Firefox, Edge)
